{
  "table_name": "gold_cart_abandonment_fact",
  "catalog": "juan_dev",
  "schema": "retail",
  "description": "Cart abandonment tracking with inventory correlation",
  "table_type": "FACT",
  "grain": "Cart Abandonment Event",
  "fields": [
    {
      "name": "abandonment_id",
      "type": "INTEGER",
      "nullable": false,
      "description": "Primary key"
    },
    {
      "name": "cart_id",
      "type": "STRING",
      "nullable": false,
      "description": "Unique cart identifier"
    },
    {
      "name": "customer_key",
      "type": "INTEGER",
      "nullable": false,
      "description": "Foreign key to customer dimension"
    },
    {
      "name": "date_key",
      "type": "INTEGER",
      "nullable": false,
      "description": "Abandonment date in YYYYMMDD format"
    },
    {
      "name": "time_key",
      "type": "INTEGER",
      "nullable": false,
      "description": "Abandonment time in HHMM format"
    },
    {
      "name": "channel_key",
      "type": "INTEGER",
      "nullable": false,
      "description": "Foreign key to channel dimension (digital only)"
    },
    {
      "name": "cart_value",
      "type": "DOUBLE",
      "nullable": false,
      "description": "Total cart value"
    },
    {
      "name": "items_count",
      "type": "INTEGER",
      "nullable": false,
      "description": "Number of items in cart",
      "validation": "items_count > 0"
    },
    {
      "name": "low_inventory_trigger",
      "type": "BOOLEAN",
      "nullable": false,
      "description": "True if any item had inventory < 5 units",
      "new": true
    },
    {
      "name": "inventory_constrained_items",
      "type": "INTEGER",
      "nullable": false,
      "description": "Count of items with qty_available < 5",
      "validation": "inventory_constrained_items <= items_count",
      "new": true
    },
    {
      "name": "minutes_in_cart",
      "type": "INTEGER",
      "nullable": false,
      "description": "Minutes items were in cart before abandonment"
    },
    {
      "name": "recovery_email_sent",
      "type": "BOOLEAN",
      "nullable": false,
      "description": "True if recovery email was sent"
    },
    {
      "name": "recovery_email_opened",
      "type": "BOOLEAN",
      "nullable": false,
      "description": "True if recovery email was opened"
    },
    {
      "name": "recovery_email_clicked",
      "type": "BOOLEAN",
      "nullable": false,
      "description": "True if recovery email link was clicked"
    },
    {
      "name": "is_recovered",
      "type": "BOOLEAN",
      "nullable": false,
      "description": "True if cart was later converted to purchase"
    },
    {
      "name": "recovery_date_key",
      "type": "INTEGER",
      "nullable": true,
      "description": "Date of recovery purchase (if is_recovered=TRUE)"
    },
    {
      "name": "recovery_revenue",
      "type": "DOUBLE",
      "nullable": false,
      "description": "Revenue from recovered cart"
    },
    {
      "name": "abandonment_stage",
      "type": "STRING",
      "nullable": false,
      "description": "cart, shipping, payment"
    },
    {
      "name": "suspected_reason",
      "type": "STRING",
      "nullable": false,
      "description": "high_shipping, price_concern, out_of_stock, technical_issue, payment_issue",
      "changed": true
    },
    {
      "name": "source_system",
      "type": "STRING",
      "nullable": false,
      "description": "Source system identifier"
    },
    {
      "name": "etl_timestamp",
      "type": "TIMESTAMP",
      "nullable": false,
      "description": "ETL processing timestamp"
    }
  ],
  "primary_key": ["abandonment_id"],
  "foreign_keys": [
    {
      "columns": ["customer_key"],
      "references": "gold_customer_dim(customer_key)"
    },
    {
      "columns": ["date_key"],
      "references": "gold_date_dim(date_key)"
    },
    {
      "columns": ["channel_key"],
      "references": "gold_channel_dim(channel_key)"
    }
  ],
  "quality_checks": [
    {
      "name": "inventory_items_bound",
      "query": "SELECT COUNT(*) FROM gold_cart_abandonment_fact WHERE inventory_constrained_items > items_count",
      "expected": 0
    },
    {
      "name": "abandonment_rate_increase",
      "query": "SELECT low_inventory_trigger, AVG(CASE WHEN is_recovered THEN 0 ELSE 1 END) AS abandonment_rate FROM gold_cart_abandonment_fact GROUP BY low_inventory_trigger",
      "description": "Abandonment rate for low_inventory=TRUE should be ~10pp higher than low_inventory=FALSE"
    },
    {
      "name": "out_of_stock_reason_correlation",
      "query": "SELECT COUNT(*) FROM gold_cart_abandonment_fact WHERE suspected_reason = 'out_of_stock' AND low_inventory_trigger = FALSE",
      "expected": 0
    }
  ],
  "version": "2.0",
  "last_updated": "2025-10-06",
  "changelog": [
    {
      "version": "2.0",
      "date": "2025-10-06",
      "changes": [
        "Added low_inventory_trigger flag",
        "Added inventory_constrained_items count",
        "Updated suspected_reason to include 'out_of_stock'",
        "Supports +10pp abandonment rate increase requirement"
      ]
    }
  ]
}

